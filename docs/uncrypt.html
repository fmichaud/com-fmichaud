<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦« Tamia - ðŸ”‘ Uncrypt Resource Service</title>
</head>
<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-container class="mt-5">
                    <v-card>
                        <v-card-title>ðŸ”‘ Decrypt the Encrypted File</v-card-title>
                        <v-card-text>
                            <v-text-field v-model="password" label="Enter the password" type="password"></v-text-field>
                            <v-btn @click="decryptFile" color="primary">Decrypt</v-btn>
                            <v-alert v-if="error" type="error">{{ error }}</v-alert>
                            <div v-if="isMarkdown" v-html="decryptedMarkdown"></div>
                            <v-card-subtitle v-else>{{ decryptedText }}</v-card-subtitle>
                        </v-card-text>
                    </v-card>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script>
        const proxyUrl = 'https://thingproxy.freeboard.io/fetch/';

        // Load CSS dynamically via proxy
        const loadCSS = (url) => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = proxyUrl + url;
            document.head.appendChild(link);
        };

        // Load JS dynamically via proxy
        const loadScript = (url, callback) => {
            const script = document.createElement('script');
            script.src = proxyUrl + url;
            script.onload = callback;
            document.body.appendChild(script);
        };

        // Load Vuetify CSS and Material Icons
        loadCSS('https://unpkg.com/vuetify@3.7.0-beta.1/dist/vuetify.min.css');
        loadCSS('https://unpkg.com/@mdi/font@7.4.47/css/materialdesignicons.min.css');

        // Load Vue.js, Vuetify, and Marked.js via proxy
        loadScript('https://unpkg.com/vue@next', () => {
            loadScript('https://unpkg.com/vuetify@next', () => {
                loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js', initVueApp);
            });
        });

        function initVueApp() {
            const { createApp } = Vue;
            const { createVuetify } = Vuetify;
            const vuetify = createVuetify();

            createApp({
                data() {
                    return {
                        password: '',
                        decryptedText: '',
                        decryptedMarkdown: '',
                        error: '',
                        isMarkdown: false,
                        fileUrl: ''
                    };
                },
                mounted() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.fileUrl = urlParams.get('url');
                    this.checkFileExtension();
                },
                methods: {
                    async fetchIVFromURL() {
                        const targetUrl = 'https://github.com/fmichaud/com-fmichaud/blob/dev/docs/Curriculum_Vitae/CV_LeadTech.md.iv';
                        const response = await fetch(proxyUrl + targetUrl);
                        if (!response.ok) {
                            throw new Error('Unable to fetch the IV from the specified URL.');
                        }
                        return await response.arrayBuffer();
                    },
                    async decryptFile() {
                        if (!this.password || !this.fileUrl) {
                            this.error = 'Please provide the password and file URL.';
                            return;
                        }
                        try {
                            const iv = await this.fetchIVFromURL();
                            const encryptedData = await fetch(proxyUrl + this.fileUrl).then(res => res.arrayBuffer());

                            const key = await crypto.subtle.importKey(
                                "raw",
                                new TextEncoder().encode(this.password),
                                { name: "PBKDF2" },
                                false,
                                ["deriveKey"]
                            );

                            const derivedKey = await crypto.subtle.deriveKey(
                                {
                                    name: "PBKDF2",
                                    salt: new TextEncoder().encode("salt"),
                                    iterations: 100000,
                                    hash: "SHA-256"
                                },
                                key,
                                { name: "AES-CBC", length: 256 },
                                true,
                                ["decrypt"]
                            );

                            const decrypted = await crypto.subtle.decrypt(
                                { name: "AES-CBC", iv: iv },
                                derivedKey,
                                encryptedData
                            );

                            const decoder = new TextDecoder();
                            this.decryptedText = decoder.decode(decrypted);
                            this.error = '';

                            if (this.isMarkdown) {
                                this.decryptedMarkdown = marked(this.decryptedText);
                            }
                        } catch (err) {
                            this.error = "Decryption error: " + err.message;
                            this.decryptedText = '';
                            this.decryptedMarkdown = '';
                        }
                    },
                    checkFileExtension() {
                        if (this.fileUrl && this.fileUrl.endsWith('.md')) {
                            this.isMarkdown = true;
                        }
                    }
                }
            }).use(vuetify).mount('#app');
        }
    </script>
</body>
</html>
